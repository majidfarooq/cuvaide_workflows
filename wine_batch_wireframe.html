<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wine Batch Creation</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-7xl mx-auto mt-8 bg-white rounded-lg shadow-lg">
        <div class="bg-blue-600 text-white p-6 rounded-t-lg">
            <h1 class="text-2xl font-bold">Create Wine Batch</h1>
        </div>
        <div class="flex gap-4 justify-center my-6">
            <div class="px-4 py-2 rounded-full border-2 border-blue-600 bg-blue-100 text-blue-800 font-semibold step-indicator" data-step="1">1. Select Blocks & Batch Info</div>
            <div class="px-4 py-2 rounded-full border-2 border-gray-300 bg-gray-100 text-gray-700 font-semibold step-indicator" data-step="2">2. Assign Vessels</div>
        </div>
        <div class="px-8 pb-8">
            <!-- Step 1: Select Vineyard Blocks & Batch Info -->
            <div class="step-content" data-step="1">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Select Vineyard Blocks</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-lg border shadow-sm p-4 hover:border-blue-600 cursor-pointer block-card" data-block="1">
                        <h3 class="text-blue-700 font-semibold mb-2">Block A1</h3>
                        <div class="text-sm text-gray-600">
                            <p>Variety: Cabernet Sauvignon</p>
                            <p>Area: 2.5 hectares</p>
                            <p>Planted: 2015</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border shadow-sm p-4 hover:border-blue-600 cursor-pointer block-card" data-block="2">
                        <h3 class="text-blue-700 font-semibold mb-2">Block B2</h3>
                        <div class="text-sm text-gray-600">
                            <p>Variety: Merlot</p>
                            <p>Area: 1.8 hectares</p>
                            <p>Planted: 2018</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border shadow-sm p-4 hover:border-blue-600 cursor-pointer block-card" data-block="3">
                        <h3 class="text-blue-700 font-semibold mb-2">Block C3</h3>
                        <div class="text-sm text-gray-600">
                            <p>Variety: Pinot Noir</p>
                            <p>Area: 3.2 hectares</p>
                            <p>Planted: 2012</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border shadow-sm p-4 hover:border-blue-600 cursor-pointer block-card" data-block="4">
                        <h3 class="text-blue-700 font-semibold mb-2">Block D4</h3>
                        <div class="text-sm text-gray-600">
                            <p>Variety: Chardonnay</p>
                            <p>Area: 2.1 hectares</p>
                            <p>Planted: 2017</p>
                        </div>
                    </div>
                </div>
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Batch Information</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Batch Name</label>
                        <input type="text" id="batchName" placeholder="Enter batch name" value="New batch" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Intake Date</label>
                        <input type="date" id="intakeDate" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Intake Time</label>
                        <input type="time" id="intakeTime" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Vintage Year</label>
                        <input type="number" id="vintageYear" placeholder="2024" min="1900" max="2030" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Tags</label>
                        <div id="tagsContainer" class="flex flex-wrap gap-2 mb-1"></div>
                        <input type="text" id="tagInput" placeholder="Add tag..." class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400 w-full"/>
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Grape Quantity (kg)</label>
                        <input type="number" id="grapeQuantity" placeholder="0" value="100" min="0" step="10" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Pressed Juice Quantity (L)</label>
                        <input type="number" id="pressedJuice" placeholder="0" value="1000" min="0" step="10" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Free Run Juice (L)</label>
                        <input type="number" id="freeRunJuice" placeholder="0" min="0" step="10"  value="100" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Total Juice Quantity (L)</label>
                        <input type="number" id="totalJuice" placeholder="0" min="0" step="0.1" readonly class="p-2 border rounded bg-gray-100">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Berry Weight (g)</label>
                        <input type="number" id="berryWeight" placeholder="0" min="0" step="0.01" value="5" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Cluster Weight (g)</label>
                        <input type="number" id="clusterWeight" placeholder="0" min="0" step="0.01" value="50" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="flex flex-col mb-2">
                        <label class="mb-1 font-medium text-gray-700">Fruit Condition</label>
                        <select id="fruitCondition" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="">Select condition</option>
                            <option value="excellent" selected>Excellent</option>
                            <option value="good">Good</option>
                            <option value="fair">Fair</option>
                            <option value="poor">Poor</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Step 2: Assign Vessels -->
            <div class="step-content hidden" data-step="2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="col-span-1">
                        <div class="bg-gray-50 border rounded-lg p-4">
                            <h3 class="text-blue-700 font-semibold mb-4 text-center">Available Vessels</h3>
                            <div class="space-y-3 vessel-list">
                                <!-- Vessels will be rendered here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <div class="bg-white border rounded-lg p-6">
                            <div class="mb-6">
                                <h3 class="text-blue-700 font-semibold mb-2">Juice Allocation Progress</h3>
                                <div class="w-full bg-gray-200 rounded-full h-4 relative">
                                    <div class="h-4 rounded-full bg-blue-600 transition-all progress-fill" style="width: 100%"></div>
                                    <div class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-gray-700 progress-text">1500L remaining</div>
                                </div>
                            </div>
                            <div class="assigned-vessels">
                                <h4 class="text-blue-700 font-semibold mb-3">Assigned Vessels</h4>
                                <div id="assignedVesselsList" class="space-y-3">
                                    <!-- Assigned vessels will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-between items-center px-8 py-4 bg-gray-50 rounded-b-lg">
            <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300" id="backBtn" disabled>Back</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" id="nextBtn">Next Step</button>
        </div>
    </div>
    <script>
        let currentStep = 1;
        let selectedBlocks = [];
        let totalJuiceQuantity = 0;
        let remainingJuice = 0;
        // --- Vessel Assignment with Counts ---
        let availableVessels = [
            { id: 1, name: 'Tank A1', capacity: 1000, count: 1 },
            { id: 2, name: 'Tank B2', capacity: 750, count: 1 },
            { id: 3, name: 'Tank C3', capacity: 500, count: 3 },
            { id: 4, name: 'Barrel D4', capacity: 300, count: 5 },
            { id: 5, name: 'Barrel E5', capacity: 225, count: 5 },
            { id: 6, name: 'Barrel F6', capacity: 150, count: 10 }, // Example: 10 available
        ];
        let assignedVessels = [];
        // --- Tags ---
        let tags = [];
        function renderTags() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            tags.forEach((tag, i) => {
                const pill = document.createElement('span');
                pill.className = 'bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs flex items-center';
                pill.innerHTML = `${tag}<button type="button" class="ml-1 text-blue-500 hover:text-red-500" onclick="removeTag(${i})">&times;</button>`;
                container.appendChild(pill);
            });
        }
        function addTag(tag) {
            tag = tag.trim();
            if (!tag || tags.includes(tag)) return;
            tags.push(tag);
            renderTags();
        }
        function removeTag(idx) {
            tags.splice(idx, 1);
            renderTags();
        }
        document.getElementById('tagInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                addTag(this.value.replace(/,$/, ''));
                this.value = '';
                e.preventDefault();
            }
        });

        // Step navigation
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentStep === 1) {
                if (validateStep1()) {
                    moveToStep(2);
                }
            } else if (currentStep === 2) {
                if (validateStep2()) {
                    alert('Batch created successfully!');
                }
            }
        });
        
        document.getElementById('backBtn').addEventListener('click', () => {
            if (currentStep === 2) {
                moveToStep(1);
            }
        });
        
        function moveToStep(step) {
            // Hide current step
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('hidden');
            // Step indicator classes
            const stepIndicators = document.querySelectorAll('.step-indicator');
            stepIndicators.forEach((el, idx) => {
                el.classList.remove('border-blue-600', 'bg-blue-100', 'text-blue-800', 'border-green-600', 'bg-green-100', 'text-green-800', 'border-gray-300', 'bg-gray-100', 'text-gray-700');
                if (idx + 1 < step) {
                    el.classList.add('border-green-600', 'bg-green-100', 'text-green-800'); // completed
                } else if (idx + 1 === step) {
                    el.classList.add('border-blue-600', 'bg-blue-100', 'text-blue-800'); // active
                } else {
                    el.classList.add('border-gray-300', 'bg-gray-100', 'text-gray-700'); // inactive
                }
            });
            // Show new step
            currentStep = step;
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('hidden');
            // Update buttons
            document.getElementById('backBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').textContent = currentStep === 2 ? 'Create Batch' : 'Next Step';
            if (currentStep === 2) {
                initializeStep2();
            }
        }
        
        function validateStep1() {
            if (selectedBlocks.length === 0) {
                alert('Please select at least one vineyard block.');
                return false;
            }
            
            const batchName = document.getElementById('batchName').value;
            const intakeDate = document.getElementById('intakeDate').value;
            const totalJuice = document.getElementById('totalJuice').value;
            
            if (!batchName || !intakeDate || !totalJuice || totalJuice <= 0) {
                alert('Please fill in all required fields.');
                return false;
            }
            
            return true;
        }
        
        function validateStep2() {
            if (remainingJuice > 0) {
                alert('Please assign all juice to vessels before creating the batch.');
                return false;
            }
            return true;
        }
        
        function initializeStep2() {
            totalJuiceQuantity = parseFloat(document.getElementById('totalJuice').value) || 0;
            remainingJuice = totalJuiceQuantity - assignedVessels.reduce((sum, v) => sum + (v.assignedCapacity || v.capacity) * v.count, 0);
            updateProgressBar();
            renderAvailableVessels();
            renderAssignedVessels();
        }
        
        // Block selection
        document.querySelectorAll('.block-card').forEach(card => {
            card.addEventListener('click', () => {
                const blockId = card.getAttribute('data-block');
                if (selectedBlocks.includes(blockId)) {
                    selectedBlocks = selectedBlocks.filter(id => id !== blockId);
                    card.classList.remove('border-blue-600', 'bg-blue-50', 'ring-2', 'ring-blue-300');
                } else {
                    selectedBlocks.push(blockId);
                    card.classList.add('border-blue-600', 'bg-blue-50', 'ring-2', 'ring-blue-300');
                }
            });
        });
        
        // Auto-calculate total juice
        function updateTotalJuice() {
            const pressed = parseFloat(document.getElementById('pressedJuice').value) || 0;
            const freeRun = parseFloat(document.getElementById('freeRunJuice').value) || 0;
            document.getElementById('totalJuice').value = pressed + freeRun;
        }
        
        document.getElementById('pressedJuice').addEventListener('input', updateTotalJuice);
        document.getElementById('freeRunJuice').addEventListener('input', updateTotalJuice);
        
        // --- Vessel Assignment with Counts ---
        function renderAvailableVessels() {
            const list = document.querySelector('.vessel-list');
            list.innerHTML = '';
            availableVessels.forEach(vessel => {
                if (vessel.count > 0) {
                    const div = document.createElement('div');
                    div.className = 'bg-white border rounded-lg p-3 flex justify-between items-center hover:border-blue-600 cursor-pointer';
                    div.innerHTML = `
                        <div>
                            <span class="font-medium text-gray-800">${vessel.name}</span>
                            <span class="text-blue-700 text-sm ml-2">${vessel.capacity}L</span>
                            <span class="ml-2 text-xs text-gray-500">× ${vessel.count}</span>
                        </div>
                        <button class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs flex items-center justify-center" onclick="assignVessel(${vessel.id})" title="Assign Vessel">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    `;
                    list.appendChild(div);
                }
            });
        }

        function renderAssignedVessels() {
            const assignedList = document.getElementById('assignedVesselsList');
            assignedList.innerHTML = '';
            assignedVessels.forEach(vessel => {
                // Store the previous valid value as a data attribute
                const vesselDiv = document.createElement('div');
                vesselDiv.className = 'border rounded-lg bg-blue-50 p-4 flex flex-col gap-2';
                vesselDiv.setAttribute('data-vessel-id', vessel.id);
                vesselDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-blue-900">${vessel.name}</span>
                        <button class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs flex items-center justify-center" onclick="removeAssignedVessel(${vessel.id})" title="Remove Vessel">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M8 6v12a2 2 0 002 2h4a2 2 0 002-2V6"/></svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-700">Capacity (L):</label>
                        <input type="number" value="${vessel.assignedCapacity}" min="1" max="${vessel.capacity}" 
                               class="w-20 p-1 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                               data-prev="${vessel.assignedCapacity}"
                               onchange="updateVesselCapacity(${vessel.id}, this.value, ${vessel.capacity})">
                        <span class="text-xs text-gray-500">/ ${vessel.capacity}L max</span>
                    </div>
                `;
                assignedList.appendChild(vesselDiv);
            });
        }

        window.assignVessel = function(id) {
            const vessel = availableVessels.find(v => v.id === id);
            if (!vessel || vessel.count === 0 || remainingJuice <= 0) return;
            // Assign only as much as is left
            const assignedAmount = Math.min(vessel.capacity, remainingJuice);
            if (assignedAmount <= 0) return;
            assignedVessels.push({
                id: Date.now() + Math.random(), // unique id for each assignment
                typeId: vessel.id, // reference to vessel type
                name: vessel.name,
                capacity: vessel.capacity,
                assignedCapacity: assignedAmount
            });
            vessel.count--;
            remainingJuice -= assignedAmount;
            updateProgressBar();
            renderAvailableVessels();
            renderAssignedVessels();
        };

        window.removeAssignedVessel = function(uniqueId) {
            const idx = assignedVessels.findIndex(v => v.id === uniqueId);
            if (idx === -1) return;
            const vessel = assignedVessels[idx];
            const type = availableVessels.find(v => v.id === vessel.typeId);
            type.count++;
            remainingJuice += vessel.assignedCapacity;
            assignedVessels.splice(idx, 1);
            updateProgressBar();
            renderAvailableVessels();
            renderAssignedVessels();
        };

        function updateVesselCapacity(uniqueId, newCapacity, maxCapacity) {
            const vessel = assignedVessels.find(v => v.id === uniqueId);
            if (vessel) {
                const oldCapacity = vessel.assignedCapacity;
                let adjustedCapacity = Math.max(1, parseInt(newCapacity));
                const availableCapacity = remainingJuice + oldCapacity;
                // Find the input element for this vessel
                const input = document.querySelector(`[data-vessel-id='${uniqueId}'] input[type='number']`);
                // Enforce max vessel capacity
                if (adjustedCapacity > maxCapacity) {
                    alert(`Cannot exceed vessel's max capacity (${maxCapacity}L).`);
                    if (input) input.value = oldCapacity;
                    return;
                }
                // Enforce total juice constraint
                if (adjustedCapacity > availableCapacity) {
                    alert(`Not enough remaining juice. Available: ${availableCapacity}L`);
                    if (input) input.value = oldCapacity;
                    return;
                }
                vessel.assignedCapacity = adjustedCapacity;
                remainingJuice = availableCapacity - adjustedCapacity;
                if (input) input.setAttribute('data-prev', adjustedCapacity);
                updateProgressBar();
            }
        }
        
        function updateProgressBar() {
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            if (totalJuiceQuantity > 0) {
                let usedJuice = totalJuiceQuantity - remainingJuice;
                usedJuice = Math.max(0, Math.min(usedJuice, totalJuiceQuantity));
                const percentage = (usedJuice / totalJuiceQuantity) * 100;
                progressFill.style.width = Math.min(percentage, 100) + '%';
                progressText.textContent = `${remainingJuice}L remaining`;
                progressText.classList.remove('text-gray-700', 'text-white');
                if (percentage > 40) {
                    progressText.classList.add('text-white');
                } else {
                    progressText.classList.add('text-gray-700');
                }
            } else {
                progressFill.style.width = '100%';
                progressText.textContent = 'Enter total juice quantity';
                progressText.classList.remove('text-white');
                progressText.classList.add('text-gray-700');
            }
        }
        
        // Initialize
        document.getElementById('intakeDate').valueAsDate = new Date();
        document.getElementById('intakeTime').value = new Date().toTimeString().slice(0, 5);
        document.getElementById('vintageYear').value = new Date().getFullYear();
        updateTotalJuice();
        renderTags();
    </script>
</body>
</html>